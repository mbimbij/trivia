<button style="display: block"
        [attr.data-testid]="'go-back'"
        (click)="router.navigate(['/games'])">
  back to games
</button>
<div
  [attr.data-testid]="'ok-section'"
  *ngIf="(game$ | async) as game; else loadingOrError"
>
  <div
    [attr.data-testid]="'game-header-section'"
  >
    <h1>Welcome to Game - "{{ game.name }}" {{ isGameEnded ? " - ENDED" : "" }}</h1>

    <h2
      [attr.data-testid]="'winner-prompt-section'"
      *ngIf="isGameEnded"><span *ngIf="playerWon(); then you_won else other_won"></span></h2>
    <ng-template #you_won>You won, Congratulations !</ng-template>
    <ng-template #other_won>{{ game.winner?.name }} won. Maybe next time.</ng-template>

    <br>
    <p>Turn #{{ game.turn }} <span *ngIf="!isGameEnded && game.isCurrentPlayer(player)">- <b>Your Turn !</b></span></p>
    <p>you are - "{{ player.name }}". Coin count: {{ player.coinCount }}</p>
    <p>Current Player - "{{ game.currentPlayer.name }}"</p>

  </div>

  <div
    *ngIf="game.isCurrentPlayer(player) && !isGameEnded"
    [attr.data-testid]="'player-action-section'"
  >
    <hr>
    <app-roll-dice [game]="game" [player]="player"></app-roll-dice>
    <app-roll-dice-results-inside-penalty-box [game]="game" [player]="player"/>
    <app-roll-dice-results-outside-penalty-box [game]="game" [player]="player"/>

    <app-answer-question
      [player]="player"
      [game]="game"
      [question]="game.currentQuestion!"></app-answer-question>

    <div
      [attr.data-testid]="'answer-question-results'"
      *ngIf="game.currentAnswer != undefined"
    >
      <hr/>

      @if (player.state == "WAITING_TO_VALIDATE_FIRST_INCORRECT_ANSWER") {
        <app-answer-question-results
          [gameId]="game.id" [player]="player"
          [isAnswerCorrectPrompt]="'First Incorrect Answer. You are given a second chance'"
          [explanations]="game.currentAnswer.explanations"
          [buttonText]="'draw 2nd question'"
        />
      } @else if (player.state == "WAITING_TO_VALIDATE_SECOND_INCORRECT_ANSWER") {
        <app-answer-question-results
          [gameId]="game.id" [player]="player"
          [isAnswerCorrectPrompt]="'Second Incorrect Answer. You are sent to the penalty box.'"
          [explanations]="game.currentAnswer.explanations"
        />

      } @else if (player.state == "WAITING_TO_VALIDATE_FIRST_CORRECT_ANSWER" || player.state == "WAITING_TO_VALIDATE_SECOND_CORRECT_ANSWER") {
        <app-answer-question-results
          [gameId]="game.id" [player]="player"
          [isAnswerCorrectPrompt]="'Correct Answer'"
          [explanations]="game.currentAnswer.explanations"
        />
      } @else {
        <p>Error: Unknown Player state: {{ player.state }}</p>
      }
    </div>
  </div>

  <hr>

  <div
    [attr.data-testid]="'game-logs-section'"
    *ngIf="(gameLogs$ | async) as logs"
  >
    <div id="messagesContainer" style="overflow-y: scroll; height:100px;">
      <!--    TODO introduire un style différent pour distinguer les logs des différents joueurs-->
      <div [ngClass]="'log-line'" *ngFor="let log of logs">{{ log.value }}</div>
    </div>
  </div>
</div>

<ng-template #loadingOrError>
  <app-error-display [gameId]="gameId" [gameLoadingError$]="gameLoadingError$"></app-error-display>
</ng-template>
